@page "/commonSamples"
@using Ab4d.SharpEngine.Browser
@using Ab4d.SharpEngine.Samples.Common
@using Ab4d.SharpEngine.Samples.Blazor.UIProvider
@using Ab4d.SharpEngine.Samples.Common.Cameras

<PageTitle>Ab4d.SharpEngine.Web - Common samples</PageTitle>

<div class="ui-container">
    <SharpEngineSceneView @ref="sharpEngineSceneView" style="width: 100%;"></SharpEngineSceneView>
    
    <div style="position: absolute; margin: 10px; left: 0; top: 0;">
        <h3>@sample_title</h3>
        <span style="white-space: pre-wrap;">@sample_subtitle</span>
    </div>

    @if (_uiProvider != null)
    {
        foreach (var rootElement in _uiProvider.GetRootUIElements())
        {
            @rootElement.BlazorElement
        }
    }
</div>

@code {
    private SharpEngineSceneView sharpEngineSceneView = null!;
    private string sample_title = "";
    private string sample_subtitle = "";

    public SharpEngineSceneView MainSceneView => sharpEngineSceneView;

    private CommonSample? _currentCommonSample;
    private CommonSample? _lastInitializedSample;
    private PointerCameraController? _pointerCameraController;
    private BlazorUIProvider? _uiProvider;

    public CommonSample? CurrentCommonSample
    {
        get => _currentCommonSample;
        set
        {
            _currentCommonSample = value;
            InitializeCommonSample();
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // Create the UI provider with a callback to trigger re-rendering
        _uiProvider = new BlazorUIProvider(() => StateHasChanged());
    }

    /// <inheritdoc />
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
            sharpEngineSceneView.SceneViewInitialized += (sender, args) => LoadFirstSample();
    }

    private void LoadFirstSample()
    {
        CurrentCommonSample = new TargetPositionCameraSample(BlazorSamplesContext.Current);
    }

    private void ResetSample()
    {
        sample_title = null;
        sample_subtitle = null;

        // Remove all lights (new sample will set setup their own lights)
        MainSceneView.Scene.Lights.Clear();

        // // Remove any registered event sources or drag surfaces
        // _inputEventsManager.ResetEventSources();
        // _inputEventsManager.RemoveAllDragSurfaces();

        // Call DisposeAllChildren on RootNode.
        // Here we will also dispose all meshes and materials with textures (textures that are cached by the Scene or GpuDevice are not disposed).
        // We also set runSceneCleanup to true so the Scene.Cleanup method is also called to release free empty memory blocks.
        // Note that we must not dispose the RootNode without disposing the Scene.
        MainSceneView.Scene.RootNode.DisposeAllChildren(disposeMeshes: true, disposeMaterials: true, disposeTextures: true, runSceneCleanup: true);

        _lastInitializedSample = null;
    }

    private void InitializeCommonSample()
    {
        if (_lastInitializedSample == _currentCommonSample)
            return; // already initialized

        ResetSample();

        if (_currentCommonSample == null)
            return;

        _currentCommonSample.InitializeSharpEngineView(MainSceneView);
        //_currentCommonSample.InitializeInputEventsManager(_inputEventsManager);

        if (_uiProvider != null)
            _currentCommonSample.CreateUI(_uiProvider);

        // Set Title and Subtitle after initializing UI, because they can be changed there
        sample_title = _currentCommonSample.Title;
        sample_subtitle = _currentCommonSample.Subtitle ?? "";

        //MainSceneView.Scene.SetCoordinateSystem(CoordinateSystems.ZUpRightHanded);

        if (_currentCommonSample != null)
        {
            if (_pointerCameraController == null) // if _pointerCameraController is not null, then InitializePointerCameraController was already called from InitializeCommonSample
            {
                // Because we render a gradient in background RootBorder and we have set MainSceneView.IsHitTestVisible to false
                // we need to set a custom eventsSourceElement when creating the PointerCameraController
                _pointerCameraController ??= new PointerCameraController(MainSceneView.SceneView);
            }

            _currentCommonSample.InitializePointerCameraController(_pointerCameraController);
        }

        _lastInitializedSample = _currentCommonSample;
    }
}
