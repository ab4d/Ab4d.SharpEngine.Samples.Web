@using Ab4d.SharpEngine.Samples.Common
@inject HttpClient Http


<div class="top-row navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">Ab4d.SharpEngine by</a><br/>
        <img src="ab4d-logo.png"/>
        <button title="Navigation menu" class="navbar-toggler" @onclick="ToggleNavMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</div>

<div class="@NavMenuCssClass nav-scrollable">
    <nav class="nav flex-column">
        @foreach (var group in _groups)
        {
            <div class="nav-item">

                <!-- Top-level collapsible item -->
                <a class="nav-title nav-link nav-item @(IsSelected(group.Location) ? "nav-item-selected" : "")" href="@("/commonSamples/" + group.Location)" 
                   @onclick="() => SelectGroup(group.Location)">
                    @group.Title
                </a>
                
                @if (IsGroupOpened(group.Location))
                {
                    <div class="submenu ms-2">
                        @foreach (var item in group.Items)
                        {
                            @* <div class="submenu-item @(item.IsSeparator ? "submenu-separator" : "")"> *@
                            <a class="nav-link nav-item nav-submenu-link @(IsSelected(item.Location) ? "nav-item-selected" : "") @(item.IsSeparator ? "nav-submenu-separator" : "")"
                               href="@("/commonSamples/" + item.Location)" @onclick="() => SelectItem(item.Location)">
                                @item.Title
                                @if (item.IsNew)
                                {
                                    <img src="images/new_icon.png" class="badge-icon" style="height: 0.8em; margin-left: 0.5em;"/>
                                }
                                @if (item.IsUpdated)
                                {
                                    <img src="images/updated_icon.png" class="badge-icon" style="height: 0.8em; margin-left: 0.5em;" title="@item.UpdateInfo"/>
                                }
                            </a>
                            @*        </div> *@
                        }
                    </div>
                }
            </div>
        }        

    </nav>
</div>

@code {
    private string? NavMenuCssClass => _isNavMenuOpened ? null : "collapse";
    private List<SamplesXmlReader.SampleGroup> _groups = new ();

    private bool _isNavMenuOpened;

    private List<string>? _openedGroups;
    
    private string? _selectedLocation;

    protected override async Task OnInitializedAsync()
    {
        string xmlContent = await Http.GetStringAsync("Samples.xml");

        var items = SamplesXmlReader.ParseXml(xmlContent);

        _groups = SamplesXmlReader.BuildGroups(items);
        _openedGroups = new();
    }

    private bool IsSelected(string itemLocation) => _selectedLocation == itemLocation;

    private bool IsGroupOpened(string groupLocation) => !_isNavMenuOpened ||  // When we have wide screen the NavMenu is not shown and show all the menu items on the left
                                                        _openedGroups == null || _openedGroups.Contains(groupLocation);

    private void ToggleNavMenu()
    {
        _isNavMenuOpened = !_isNavMenuOpened;
    }

    private void SelectItem(string itemLocation)
    {
        _selectedLocation = itemLocation;
        
        if (_isNavMenuOpened)
            ToggleNavMenu();
    }

    private void SelectGroup(string groupLocation)
    {
        _selectedLocation = groupLocation;

        if (_openedGroups.Contains(groupLocation))
            _openedGroups.Remove(groupLocation);
        else
            _openedGroups.Add(groupLocation);
    }
}
